---

- name: Check for required variables
  fail: msg="Variable {{ item }} must be defined to use this role"
  when: item is undefined
  with_items:
    - namespace
    - pvc1_name
    - pvc2_name

- name: Create Pod
  kubernetes.core.k8s:
    state: present
    definition:
      kind: Pod
      apiVersion: v1
      metadata:
        generateName: verify-
        namespace: "{{ namespace }}"
      spec:
        containers:
          - name: busybox
            image: busybox
            imagePullPolicy: IfNotPresent
            command: ["/bin/sh", "-c"]
            args: ["find /mnt | xargs sha256sum | sed 's|^/mnt/|/mnt2/|' | grep -v lost+found | sha256sum -c"]
            volumeMounts:
              - name: pvc1
                mountPath: "/mnt"
              - name: pvc2
                mountPath: "/mnt2"
        restartPolicy: OnFailure
        terminationGracePeriodSeconds: 2
        volumes:
          - name: pvc1
            persistentVolumeClaim:
              claimName: "{{ pvc1_name }}"
          - name: pvc2
            persistentVolumeClaim:
              claimName: "{{ pvc2_name }}"
  register: res

- name: Wait for Pod to complete
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    name: "{{ res.result.metadata.name }}"
    namespace: "{{ namespace }}"
  register: res2
  until: >
    res2.resources | length > 0 and
    res2.resources[0].status.phase=="Succeeded"
  delay: 1
  retries: 60

- name: Delete Pod
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Pod
    name: "{{ res.result.metadata.name }}"
    namespace: "{{ namespace }}"
