# Checklists for various maintenance tasks

## Creating a release

* Update [CHANGELOG.md](CHANGELOG.md) with the major changes since the last
  release
* Update the helm chart template
  * In [Chart.yaml](helm/volsync/Chart.yaml), update `version`, `appVersion`,
    and `annotations.artifacthub.io/changes`
  * Also update the
    [annotation](https://artifacthub.io/docs/topics/annotations/helm/) for the
    signing key if necessary (`annotations.artifacthub.io/signKey`)
* Create a PR w/ the above and commit to `main`
* Branch to `release-X.Y`
* Tag the release: `vX.Y.Z`
* Ensure tagged container images become available on Quay for all containers

### Release the updated Helm chart

* Package the chart:  
  `$ helm package helm/volsync`
* Sign the chart (uses the [GPG Helm
  plugin](https://artifacthub.io/packages/helm-plugin/gpg/gpg)):  
  `$ helm gpg sign volsync-X.Y.Z.tgz`
* Add these files to the `backube/helm-charts` repo:  
  `cd ../helm-charts`  
  `./build-index ../volsync/volsync-X.Y.Z.tgz`
* Create a PR against that repo w/ the changes

## Creating/Updating the operator bundle

* Note: For packaging as an operator, the CSV file is normally auto-generated, but some updates may be necessary
  by hand.  If making updates by hand, edit the CSV template in [volsync.clusterserviceversion.yaml](config/manifests/bases/volsync.clusterserviceversion.yaml)

* If updates are made to the CSV, any of the CRDs or RBAC (any changes in config essentially) then run the bundle
  command to ensure the bundle manifests are up-to-date (note that the version here is not important as it will
  be replaced before publishing the bundle downstream.  Using 0.0.0 to make it obvious that the version in source
  will not be the same one that will be published):

  `$ make bundle VERSION=0.0.0`

### Steps to generate a bundle, bundle image, etc

Most of these steps will most likely be automated downstream, but they can be run manually to generate a bundle
at a specific version as well as a bundle image, catalog source image, etc.

Generally the metadata generated by these commands should not be committed into this repo

* Generate a bundle at a specific version (0.4.1 in this example) that will be published to channel "stable" and channel "release-0.4", while making the default channel "stable":

  `$ make bundle VERSION=0.0.1 CHANNELS=stable,release-0.4 DEFAULT_CHANNEL=stable`

* To make and push a bundle image (this will be used by an operator catalog) that contains the bundle:

  `$ make bundle-build BUNDLE_IMG=quay.io/backube/volsync-operator-bundle:v0.4.1`  
  `$ make bundle-push BUNDLE_IMG=quay.io/backube/volsync-operator-bundle:v0.4.1`

* To Make and push a catalog image (this can be done for testing) that will use the bundle image in the previous step:

  `$ make catalog-build BUNDLE_IMG=quay.io/backube/volsync-operator-bundle:v0.4.1 CATALOG_IMG=quay.io/backube/test-operator-catalog:v0.4.1`  
  `$ make catalog-push BUNDLE_IMG=quay.io/backube/volsync-operator-bundle:v0.4.1 CATALOG_IMG=quay.io/backube/test-operator-catalog:v0.4.1`

## Updating tool/dependency versions

* Go
  * Change the version number in [operator.yml](.github/workflows/operator.yml)
  * Change the version number in [go.mod](go.mod)
  * Change the version number for the builder images in
    * [Dockerfile](Dockerfile)
    * [mover-rclone/Dockerfile](mover-rclone/Dockerfile)
    * [mover-restic/Dockerfile](mover-restic/Dockerfile)
  * Update the OpenShift CI builder images & image substitution rules
* [golangci-lint](https://github.com/golangci/golangci-lint/releases)
  * Change the version number in [Makefile](Makefile)
  * Check for added/deprecated linters and adjust [.golangci.yml](.golangci.yml)
    as necessary
* [Helm](https://github.com/helm/helm/releases)
  * Change the version number in [Makefile](Makefile)
* [Kind](https://github.com/kubernetes-sigs/kind/releases)
  * Kind version: Change the version number in
    [operator.yml](.github/workflows/operator.yml)
  * Kubernetes version used by kind:
    * [Available kubernetes
      versions](https://hub.docker.com/r/kindest/node/tags?page=1&ordering=last_updated)
    * Update the default kube version in the
      [setup-kind-cluster.sh](./hack/setup-kind-cluster.sh) script to be the
      latest image
    * Update the matrix list for CI in
      [operator.yml](.github/workflows/operator.yml)
* [Kuttl](https://github.com/kudobuilder/kuttl/releases)
  * Change the version number in [Makefile](Makefile)
* [operator-sdk](https://github.com/operator-framework/operator-sdk/releases)
  * Change the version number in [Makefile](Makefile)
  * Follow the [upgrade
    guide](https://sdk.operatorframework.io/docs/upgrading-sdk-version/) as
    appropriate
* [Rclone](https://github.com/rclone/rclone/releases)
  * Change the version number in
    [mover-rclone/Dockerfile](mover-rclone/Dockerfile) and update GIT hash to match
* [Restic](https://github.com/restic/restic/releases)
  * Change the version number in
    [mover-restic/Dockerfile](mover-restic/Dockerfile), and update GIT hash to
    match
